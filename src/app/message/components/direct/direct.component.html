<app-header></app-header>
<ion-grid class="content-grid">
  <ion-row class="content-row ion-justify-content-center">
    <ion-col class="content-col" size-xs="12" size-sm="8" size-md="8" size-lg="7" size-xl="5">
      <div class="messages-container">
        <app-column-header [previousLocationFallback]="'/message'" class="messages-header">
          <ng-container *ngIf="interlocutorData$ | async as interlocutorData">
            <ion-avatar slot="start">
              <img src="{{ interlocutorData?.interlocutor_avatar_thumbnail }}" alt="avatar" />
            </ion-avatar>
            <ion-label>
              <h3>
                {{ interlocutorData?.interlocutor }}
              </h3>
            </ion-label>
          </ng-container>
        </app-column-header>
        <ion-content
          class="messages-content ion-margin-top"
          id="content"
          [scrollEvents]="true"
          (click)="resetContext()"
        >
          <ion-infinite-scroll threshold="800px" [disabled]="true" (ionInfinite)="loadData()" position="top">
            <ion-infinite-scroll-content loadingText="{{ 'messages.direct.loading-text' | translate }}">
            </ion-infinite-scroll-content>
          </ion-infinite-scroll>
          <ion-list class="ion-margin-bottom">
            <div *ngFor="let message of directService.messages$ | async; let i = index">
              <ion-row
                *ngIf="message.id && needToRenderDateString(i) | async"
                class="ion-justify-content-center ion-align-items-center ion-padding-vertical"
              >
                {{ getDateString(message.created) }}
              </ion-row>
              <ion-row
                class="width100"
                *ngIf="message.sender !== directService.currentUserId && directService.currentUserId"
              >
                <div class="message-container">
                  <div class="received-message message">
                    <div class="message-text wrap-text">{{ message.body }}</div>
                  </div>
                  <div class="timeline timeline-received">
                    {{ timeFromDatetime(message.created) }}
                  </div>
                </div>
              </ion-row>
              <ion-row
                class="width100 ion-justify-content-end"
                id="{{ message?.id }}"
                *ngIf="message.sender === directService.currentUserId && directService.currentUserId"
              >
                <div class="message-container" (contextmenu)="initMessageMenuContext($event, message)">
                  <div class="sent-message message">
                    <div class="message-text wrap-text">{{ message.body }}</div>
                  </div>
                  <div class="timeline timeline-sent width100" *ngIf="message.id">
                    {{ timeFromDatetime(message.created) }}
                    <ion-icon
                      class="checkmark"
                      color="{{ getCheckmarkColor(message) }}"
                      name="checkmark-done-outline"
                    ></ion-icon>
                  </div>
                  <div class="timeline timeline-sent width100" *ngIf="!message.id">
                    <ion-icon name="time-outline"></ion-icon>
                  </div>
                </div>
              </ion-row>
            </div>
            <div #bottomPoint></div>
          </ion-list>
        </ion-content>
        <ion-toolbar class="messages-footer" (keydown.enter)="send()" (keydown.escape)="cancelUpdate()">
          <ion-row
            *ngIf="isUpdate"
            class="ion-padding-horizontal ion-align-items-center"
            (click)="showUpdatingMessage()"
          >
            <ion-col size="1" class="cursor-pointer">
              <ion-item lines="none">
                <ion-icon name="pencil-outline"></ion-icon>
              </ion-item>
            </ion-col>
            <ion-col size="10" class="cursor-pointer" (click)="showUpdatingMessage()">
              <ion-row>{{ 'messages.direct.edit-message' | translate }}:</ion-row>
              <ion-row class="default-message-container">{{ directService.defaultUpdateMessage }}</ion-row>
            </ion-col>
            <ion-col size="1" class="ion-justify-content-end cursor-pointer ion-align-items-end">
              <ion-item (click)="cancelUpdate()" lines="none">
                <ion-icon name="close-outline"></ion-icon>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row class="ion-justify-content-between ion-align-items-center">
            <ion-col class="ion-item-bordered border-radius24">
              <ion-textarea *ngIf="!isUpdate" [(ngModel)]="directService.message" name="message"></ion-textarea>
              <ion-textarea
                *ngIf="isUpdate"
                [(ngModel)]="directService.updateMessage.body"
                name="message"
              ></ion-textarea>
            </ion-col>
            <ion-button
              (click)="send()"
              [disabled]="isUpdate ? !directService.updateMessage.body?.length : !directService.message?.length"
              class="ion-margin-start"
            >
              {{ isUpdate ? 'update' : 'send' }}
            </ion-button>
          </ion-row>
        </ion-toolbar>
      </div>
    </ion-col>
  </ion-row>
</ion-grid>
